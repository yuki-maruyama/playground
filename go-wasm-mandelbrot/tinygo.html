<!DOCTYPE html>
<html lang="ja">

<head>
  <title>go webassembly</title>
  <script src="tinygo_wasm_exec.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bignumber.js/9.1.2/bignumber.min.js"
    integrity="sha512-9JMv6qShmz4L6iAvMaEoIaFtS4XGSk/jeTSR2vzieg0XS5njYvBvYk0YcvI59dLN/0B+QnG5HfGR+Mqubl78SA=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    const go = new Go();
    let instance;
    WebAssembly.instantiateStreaming(
      fetch("tinygo.main.wasm"),
      go.importObject
    ).then((res) => {
      instance = res.instance;
      go.run(instance);
    });

    function logMessage(message) {
      const logView = document.getElementById("logView");
      logView.innerHTML += message + "<br>";
    }

    async function calcPiJS(itr, prec) {
      console.log(`itr: ${itr} prec: ${prec}`);
      let time = performance.now();
      const two = new BigNumber(2);
      let pi = new BigNumber(1);
      let a = new BigNumber(1);
      let b = new BigNumber(0.5);
      let x = new BigNumber(0);

      for (let i = 2; i < itr; i += 2) {
        let y = new BigNumber(i).dividedBy(i + 1);
        a = a.times(y);
        x = a.times(b);
        pi = pi.plus(x);
        b = b.dividedBy(two);
      }

      pi = pi.times(2);
      console.log("calcPiJS:", performance.now() - time, "ms");
      console.log(pi.toFixed(prec));
    }

    async function calcPiGo(itr, prec) {
      let time = performance.now();
      console.log(`itr: ${itr} prec: ${prec}`);
      const result = calcPi(itr, prec);
      console.log("calcPiGo:", performance.now() - time, "ms");
      console.log(result);
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const runButton = document.getElementById("runButton");
      runButton.addEventListener("click", (async () => {
        console.log("--- wasm ---");
        await calcPiGo(1000, 30);
        console.log("--- js ---");
        await calcPiJS(1000, 30);
      }));
    });
  </script>
</head>

<body>
  <button id="runButton">Run</button>
  <div id="logView"></div>
</body>

</html>